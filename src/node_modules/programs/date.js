/*
   This file is part of UNIX Guide for the Perplexed project.
   Copyright (C) 2014 by Assaf Gordon <assafgordon@gmail.com>
   Released under GPLv3 or later, with the following addition:

     As additional permission under GNU GPL version 3 section 7, you
     may distribute non-source (e.g., minimized or compacted) forms of
     that code without the copy of the GNU GPL normally required by
     section 4, provided you include this license notice and a URL
     through which recipients can access the Corresponding Source.

   See: https://www.gnu.org/philosophy/javascript-trap.html

   POSIX Shell Command Language Standard:
   http://pubs.opengroup.org/onlinepubs/009695399/utilities/xcu_chap02.html
*/

/*
A Naive implementation of date(1)
*/
"use strict";

var sprintf = require('utils/sprintf');
var ProgramBase = require('programs/program_base');

module.exports = ProgramDate;

function ProgramDate() {
	this.name = "ProgramDate";
}
ProgramDate.prototype = new ProgramBase();
ProgramDate.prototype.constructor = ProgramDate;

/*
Partial Implementation of 'date'
*/
ProgramDate.prototype.internal_run=function() {
	if (this.argv[0] === "--help") {
		this.show_help();
		this.exit(0);
	}

	if (this.argv[0] == "--version") {
		this.show_version();
		this.exit(0);
	}

	// Current implementation is limited to printing the date,
	// no "format" or other parameters are supported
	if (this.argv.length>0)
		throw new ProgramBase.ProgramFeatureNotImplemented("date","options",
			"date options are not implemented");

	//No parameters - just print the date
	var tm = this.runtime.getOS().time(); // get global system time
	var dt = new Date(tm*1000); // time is in seconds, convert to Javascript's milliseconds

	var weekday = new Array(7);
	weekday[0]=  "Sun";
	weekday[1] = "Mon";
	weekday[2] = "Tue";
	weekday[3] = "Wed";
	weekday[4] = "Thu";
	weekday[5] = "Fri";
	weekday[6] = "Sat";

	var month_name = new Array(12);
	month_name[0] = "Jan";
	month_name[1] = "Feb";
	month_name[2] = "Mar";
	month_name[3] = "Apr";
	month_name[4] = "May";
	month_name[5] = "Jun";
	month_name[6] = "Jul";
	month_name[7] = "Aug";
	month_name[8] = "Sep";
	month_name[9] = "Oct";
	month_name[10] = "Nov";
	month_name[11] = "Dec";

	//TODO: add TimeZone name before year
	var text = sprintf.sprintf("%s %s %d %02d:%02d:%02d %04d",
		weekday[dt.getDay()],
		month_name[dt.getMonth()],
		dt.getDate(),
		dt.getHours(),
		dt.getMinutes(),
		dt.getSeconds(),
		dt.getFullYear());

	this.runtime.stdout.put_line(text);

	return 0;
}

